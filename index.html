<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Gest√£o de Neoplasias | SESC</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a1628">
<link rel="apple-touch-icon" href="icon.png">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:        #0a1628;
  --surface:   #111f38;
  --surface2:  #172340;
  --surface3:  #1e2e4f;
  --border:    #1f3260;
  --border2:   #2a3f6e;
  --text:      #e8edf5;
  --muted:     #7a8fb5;
  --accent:    #3d8ef0;
  --accent2:   #57a6ff;
  --gold:      #f0b429;
  --danger:    #e5484d;
  --success:   #30a46c;
  --warning:   #f5a623;
  --radius:    14px;
  --shadow:    0 8px 32px rgba(0,0,0,.4);
}

body {
  font-family: 'DM Sans', system-ui, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 0;
  overflow-x: hidden;
}

/* ‚îÄ‚îÄ‚îÄ BACKGROUND PATTERN ‚îÄ‚îÄ‚îÄ */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 50% at 20% -10%, rgba(61,142,240,.12) 0%, transparent 60%),
    radial-gradient(ellipse 60% 40% at 80% 110%, rgba(87,166,255,.08) 0%, transparent 60%);
  pointer-events: none;
  z-index: 0;
}

/* ‚îÄ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ */
.page-wrap {
  position: relative;
  z-index: 1;
  max-width: 980px;
  margin: 0 auto;
  padding: 32px 20px 60px;
}

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.app-header {
  text-align: center;
  margin-bottom: 36px;
  animation: fadeDown .6s ease both;
}

.app-header .eyebrow {
  font-size: .7rem;
  font-weight: 700;
  letter-spacing: 3px;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 8px;
}

.app-header h1 {
  font-family: 'Instrument Serif', Georgia, serif;
  font-size: clamp(1.8rem, 5vw, 2.8rem);
  font-weight: 400;
  color: var(--text);
  line-height: 1.1;
  margin-bottom: 6px;
}

.app-header h1 em {
  font-style: italic;
  color: var(--accent2);
}

.app-header p {
  font-size: .82rem;
  color: var(--muted);
  letter-spacing: .5px;
}

.header-line {
  width: 60px;
  height: 2px;
  background: linear-gradient(90deg, var(--accent), transparent);
  margin: 16px auto 0;
  border-radius: 2px;
}

/* ‚îÄ‚îÄ‚îÄ ALERT ‚îÄ‚îÄ‚îÄ */
.alert-box {
  background: rgba(245,166,35,.08);
  border: 1px solid rgba(245,166,35,.3);
  border-radius: var(--radius);
  padding: 14px 18px;
  margin-bottom: 24px;
  display: none;
  animation: fadeIn .4s ease;
}
.alert-box.show { display: flex; gap: 12px; align-items: flex-start; }
.alert-icon { font-size: 1.2rem; flex-shrink: 0; margin-top: 1px; }
.alert-box strong { font-size: .82rem; color: var(--warning); display: block; margin-bottom: 4px; }
.alert-box p { font-size: .8rem; color: #c8a05a; line-height: 1.5; margin: 0; }

/* ‚îÄ‚îÄ‚îÄ MONTH SELECTOR ‚îÄ‚îÄ‚îÄ */
.month-bar {
  display: flex;
  justify-content: center;
  margin-bottom: 28px;
  animation: fadeDown .6s .1s ease both;
}
.month-select-wrap {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 50px;
  padding: 6px 8px 6px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  box-shadow: var(--shadow);
}
.month-select-wrap label {
  font-size: .75rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1.5px;
  white-space: nowrap;
}
.month-select-wrap select {
  background: var(--surface3);
  border: none;
  border-radius: 40px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: .9rem;
  font-weight: 600;
  padding: 8px 16px;
  outline: none;
  cursor: pointer;
  color-scheme: dark;
  min-width: 200px;
}

/* ‚îÄ‚îÄ‚îÄ CARD ‚îÄ‚îÄ‚îÄ */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 28px;
  margin-bottom: 20px;
  box-shadow: var(--shadow);
  animation: fadeUp .5s ease both;
}

.card-title {
  font-size: .68rem;
  font-weight: 700;
  letter-spacing: 2.5px;
  text-transform: uppercase;
  color: var(--accent);
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-title::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border2);
}

/* ‚îÄ‚îÄ‚îÄ FORM GRID ‚îÄ‚îÄ‚îÄ */
.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 20px;
}

.field { display: flex; flex-direction: column; gap: 6px; }

.field label {
  font-size: .75rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.field input[type="text"],
.field input[type="tel"],
.field select {
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 10px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: .9rem;
  padding: 11px 14px;
  outline: none;
  transition: border-color .2s, box-shadow .2s, background .2s;
  -webkit-appearance: none;
  color-scheme: dark;
}
.field input:focus,
.field select:focus {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(61,142,240,.18);
  background: var(--surface3);
}
.field select option { background: var(--surface2); }

/* ‚îÄ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ */
.btn-row {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  justify-content: center;
  margin-top: 4px;
}

.btn-row-secondary {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  justify-content: center;
  margin-top: 12px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

button {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  padding: 10px 20px;
  border-radius: 10px;
  border: none;
  font-family: 'DM Sans', sans-serif;
  font-size: .83rem;
  font-weight: 600;
  cursor: pointer;
  transition: opacity .15s, transform .12s, box-shadow .15s;
  white-space: nowrap;
}
button:hover { opacity: .88; transform: translateY(-1px); }
button:active { transform: translateY(0); opacity: 1; }

.btn-add    { background: var(--accent); color: #fff; box-shadow: 0 4px 14px rgba(61,142,240,.35); }
.btn-report { background: var(--success); color: #fff; box-shadow: 0 4px 14px rgba(48,164,108,.3); }
.btn-annual { background: #1a56c4; color: #fff; box-shadow: 0 4px 14px rgba(26,86,196,.3); }
.btn-danger { background: var(--danger); color: #fff; box-shadow: 0 4px 14px rgba(229,72,77,.3); }
.btn-ghost {
  background: var(--surface2);
  color: var(--muted);
  border: 1px solid var(--border2);
  font-size: .76rem;
  padding: 7px 14px;
}
.btn-ghost:hover { color: var(--text); border-color: var(--accent); }
.btn-edit   { background: rgba(240,180,41,.15); color: var(--gold); border: 1px solid rgba(240,180,41,.25); padding: 6px 12px; font-size: .76rem; }
.btn-del    { background: rgba(229,72,77,.12); color: var(--danger); border: 1px solid rgba(229,72,77,.2); padding: 6px 12px; font-size: .76rem; }
.btn-edit:hover { background: rgba(240,180,41,.25); }
.btn-del:hover  { background: rgba(229,72,77,.22); }

/* ‚îÄ‚îÄ‚îÄ PATIENT LIST ‚îÄ‚îÄ‚îÄ */
.list-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 14px;
}
.list-count {
  font-size: .75rem;
  font-weight: 600;
  color: var(--muted);
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 3px 12px;
}

.patient-card {
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
  transition: border-color .2s, background .2s;
  animation: fadeIn .3s ease both;
}
.patient-card:hover { border-color: var(--border2); background: var(--surface3); }

.patient-info { display: flex; flex-direction: column; gap: 3px; flex: 1; min-width: 0; }

.patient-name {
  font-size: .93rem;
  font-weight: 700;
  color: var(--text);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.patient-phone {
  font-size: .78rem;
  color: var(--accent2);
  font-weight: 500;
}

.patient-diag {
  font-size: .76rem;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.patient-actions { display: flex; gap: 6px; flex-shrink: 0; }

.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--muted);
}
.empty-state .empty-icon { font-size: 2.5rem; margin-bottom: 10px; opacity: .4; }
.empty-state p { font-size: .85rem; }

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  inset: 0;
  background: rgba(0,0,0,.65);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  align-items: center;
  justify-content: center;
}
.modal.open { display: flex; animation: fadeIn .2s ease; }

.modal-box {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: 20px;
  padding: 32px;
  width: 90%;
  max-width: 480px;
  box-shadow: 0 24px 60px rgba(0,0,0,.6);
  animation: scaleIn .25s ease;
}

.modal-box h3 {
  font-family: 'Instrument Serif', Georgia, serif;
  font-size: 1.4rem;
  font-weight: 400;
  color: var(--text);
  text-align: center;
  margin-bottom: 20px;
}

.warning-strip {
  background: rgba(245,166,35,.08);
  border: 1px solid rgba(245,166,35,.25);
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 18px;
  font-size: .8rem;
  color: #c8a05a;
  line-height: 1.6;
}
.warning-strip strong { color: var(--warning); display: block; margin-bottom: 4px; }

.modal-box label {
  display: block;
  font-size: .73rem;
  font-weight: 600;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 8px;
}

.modal-box select {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border2);
  border-radius: 10px;
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  font-size: .95rem;
  font-weight: 600;
  padding: 12px 14px;
  outline: none;
  margin-bottom: 16px;
  color-scheme: dark;
}
.modal-box select:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(61,142,240,.18); }

.info-strip {
  background: rgba(61,142,240,.08);
  border: 1px solid rgba(61,142,240,.2);
  border-radius: 10px;
  padding: 12px 14px;
  margin-bottom: 20px;
  font-size: .8rem;
  color: #7aaddd;
  line-height: 1.6;
}
.info-strip strong { color: var(--accent2); display: block; margin-bottom: 4px; }

.modal-btns { display: flex; gap: 10px; }
.modal-btns button { flex: 1; justify-content: center; }

/* ‚îÄ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ‚îÄ */
@keyframes fadeDown {
  from { opacity: 0; transform: translateY(-16px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(14px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes fadeIn {
  from { opacity: 0; }
  to   { opacity: 1; }
}
@keyframes scaleIn {
  from { opacity: 0; transform: scale(.95); }
  to   { opacity: 1; transform: scale(1); }
}

/* ‚îÄ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ‚îÄ */
@media(max-width: 600px) {
  .page-wrap { padding: 20px 12px 48px; }
  .card { padding: 20px 16px; }
  .form-grid { grid-template-columns: 1fr; }
  .btn-row { flex-direction: column; align-items: stretch; }
  .btn-row button { justify-content: center; }
  .patient-card { flex-direction: column; align-items: flex-start; }
  .patient-actions { align-self: flex-end; }
  .modal-btns { flex-direction: column; }
}
</style>
</head>
<body>

<div class="page-wrap">

  <!-- HEADER -->
  <header class="app-header">
    <div class="eyebrow">SESC ¬∑ Sa√∫de da Mulher</div>
    <h1>Formul√°rio Hospitalar de <em>Neoplasias</em></h1>
    <p>Unidade M√≥vel ‚Äî Gest√£o e Relat√≥rios Est√°ticos</p>
    <div class="header-line"></div>
  </header>

  <!-- ALERT -->
  <div class="alert-box" id="alertBackup">
    <div class="alert-icon">‚ö†Ô∏è</div>
    <div>
      <strong>Dados de meses anteriores foram limpos</strong>
      <p>Para gerar o relat√≥rio anual completo, importe o backup com os dados dos meses anteriores usando o bot√£o "Importar Backup" abaixo.</p>
    </div>
  </div>

  <!-- MONTH SELECTOR -->
  <div class="month-bar">
    <div class="month-select-wrap">
      <label>M√™s</label>
      <select id="mesSelecionado" onchange="carregarPacientesMes()"></select>
    </div>
  </div>

  <!-- FORM CARD -->
  <div class="card" style="animation-delay:.05s">
    <div class="card-title">Cadastrar Paciente</div>
    <form id="formPaciente" onsubmit="event.preventDefault(); adicionarPaciente();">
      <div class="form-grid">
        <div class="field">
          <label>Nome do Paciente</label>
          <input type="text" id="nome" placeholder="Digite o nome completo" oninput="this.value=this.value.toUpperCase()" required>
        </div>
        <div class="field">
          <label>Telefone</label>
          <input type="tel" id="telefone" placeholder="(xx) xxxxx-xxxx" oninput="mascaraTelefone(this)" maxlength="14" required>
        </div>
        <div class="field">
          <label>Categoria</label>
          <select id="categoria" onchange="atualizaSubcategorias()" required>
            <option value="">‚Äî Selecione ‚Äî</option>
            <option value="C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO">C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO</option>
            <option value="ATIPIAS EM C√âLULAS ESCAMOSAS">ATIPIAS EM C√âLULAS ESCAMOSAS</option>
            <option value="ATIPIAS EM C√âLULAS GLANDULARES">ATIPIAS EM C√âLULAS GLANDULARES</option>
          </select>
        </div>
        <div class="field">
          <label>Subcategoria</label>
          <select id="subcategoria" required>
            <option value="">‚Äî Selecione ‚Äî</option>
          </select>
        </div>
      </div>

      <div class="btn-row">
        <button type="submit" class="btn-add">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Adicionar Paciente
        </button>
        <button type="button" class="btn-report" onclick="gerarPDF()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          Relat√≥rio Mensal
        </button>
        <button type="button" class="btn-annual" onclick="abrirModalRelatorioAnual()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Relat√≥rio Anual
        </button>
        <button type="button" class="btn-danger" onclick="limparComSeguranca()">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
          Limpar
        </button>
      </div>

      <div class="btn-row-secondary">
        <button type="button" class="btn-ghost" onclick="exportarBackup()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Exportar Backup
        </button>
        <button type="button" class="btn-ghost" onclick="document.getElementById('inputBackup').click()">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Importar Backup
        </button>
        <input type="file" id="inputBackup" style="display:none" accept=".json" onchange="importarBackup(event)">
      </div>
    </form>
  </div>

  <!-- PATIENT LIST CARD -->
  <div class="card" style="animation-delay:.1s">
    <div class="list-header">
      <div class="card-title" style="margin-bottom:0;flex:1">Pacientes Cadastrados</div>
      <span class="list-count" id="listCount">0 registros</span>
    </div>
    <div id="listaPacientes"></div>
  </div>

</div><!-- /page-wrap -->

<!-- MODAL RELAT√ìRIO ANUAL -->
<div id="modalRelatorioAnual" class="modal">
  <div class="modal-box">
    <h3>Relat√≥rio Anual</h3>

    <div class="warning-strip">
      <strong>‚ö†Ô∏è Aten√ß√£o</strong>
      Se voc√™ limpou dados de meses anteriores, importe o backup primeiro para que todos os meses apare√ßam no relat√≥rio.
    </div>

    <label for="anoRelatorioAnual">Ano de refer√™ncia</label>
    <select id="anoRelatorioAnual"></select>

    <div class="info-strip" id="mesesDisponiveis">
      <strong>Verificando dados dispon√≠veis‚Ä¶</strong>
    </div>

    <div class="modal-btns">
      <button class="btn-annual" onclick="confirmarRelatorioAnual()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Gerar Relat√≥rio
      </button>
      <button class="btn-danger" onclick="fecharModalRelatorioAnual()">Cancelar</button>
    </div>
  </div>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js')
    .then(() => console.log("PWA: Offline ativo"))
    .catch(err => console.log("PWA erro:", err));
}

const azulEscuro = "#0b3c5d";
const cinzaEscuro = "#444444";
const TEXTO_CURTO = "Les√£o intra-epitelial de baixo grau (HPV e neoplasia intra-epitelial cervical grau I)";
const TEXTO_LONGO = "Les√£o intra-epitelial de baixo grau (compreendendo efeito citop√°tico pelo HPV e neoplasia intra-epitelial cervical grau I)";

const subcategorias = {
  "C√âLULAS AT√çPICAS DE SIGNIFICADO INDETERMINADO": [
    "Escamosas: possivelmente n√£o neopl√°sicas (ASC-US)",
    "Escamosas: n√£o se pode afastar les√£o de alto grau (ASC-H)",
    "Glandulares: possivelmente n√£o neopl√°sicas",
    "Glandulares: n√£o se pode afastar les√£o de alto grau",
    "De origem indefinida: possivelmente n√£o neopl√°sicas",
    "De origem indefinida: n√£o se pode afastar les√£o de alto grau"
  ],
  "ATIPIAS EM C√âLULAS ESCAMOSAS": [
    TEXTO_CURTO,
    "Les√£o intra-epitelial de alto grau (neoplasias intra-epiteliais cervicais graus II e III)",
    "Les√£o intra-epitelial de alto grau, n√£o podendo excluir micro-invas√£o",
    "Carcinoma epiderm√≥ide invasor"
  ],
  "ATIPIAS EM C√âLULAS GLANDULARES": [
    'Adenocarcinoma "in situ"',
    "Adenocarcinoma invasor, cervical",
    "Adenocarcinoma invasor, endometrial",
    "Adenocarcinoma invasor SOE, (sem outras especifica√ß√µes)"
  ]
};

let pacientes = [];

function mascaraTelefone(campo) {
  let v = campo.value.replace(/\D/g,"");
  if(v.length>0) v="("+v;
  if(v.length>3) v=v.slice(0,3)+")"+v.slice(3);
  if(v.length>9) v=v.slice(0,9)+"-"+v.slice(9,13);
  campo.value=v;
}

function atualizaSubcategorias() {
  const cat = document.getElementById("categoria").value;
  const sub = document.getElementById("subcategoria");
  sub.innerHTML = '<option value="">‚Äî Selecione ‚Äî</option>';
  if(subcategorias[cat]) subcategorias[cat].forEach(s => {
    const o = document.createElement("option");
    o.value = o.textContent = s;
    sub.appendChild(o);
  });
}

function adicionarPaciente() {
  const campoNome = document.getElementById("nome");
  const nome = campoNome.value.trim();
  const telefone = document.getElementById("telefone").value.trim();
  const categoria = document.getElementById("categoria").value;
  const subcategoria = document.getElementById("subcategoria").value;
  if(!nome||!telefone||!categoria||!subcategoria){ alert("Preencha todos os campos!"); return; }
  pacientes.push({nome,telefone,categoria,subcategoria});
  salvarPacientes(); atualizarLista();
  resetarCamposInput();
  setTimeout(()=>campoNome.focus(),150);
}

function atualizarLista() {
  const container = document.getElementById("listaPacientes");
  const countEl = document.getElementById("listCount");
  countEl.textContent = pacientes.length + (pacientes.length===1?" registro":" registros");

  if(pacientes.length===0){
    container.innerHTML=`<div class="empty-state"><div class="empty-icon">üóÇÔ∏è</div><p>Nenhum paciente cadastrado neste m√™s.</p></div>`;
    return;
  }

  container.innerHTML = pacientes.map((p,idx)=>{
    const diag = p.subcategoria===TEXTO_LONGO ? TEXTO_CURTO : p.subcategoria;
    return `<div class="patient-card">
      <div class="patient-info">
        <span class="patient-name">${p.nome}</span>
        <span class="patient-phone">${p.telefone}</span>
        <span class="patient-diag">${diag}</span>
      </div>
      <div class="patient-actions">
        <button class="btn-edit" onclick="editarPaciente(${idx})">Editar</button>
        <button class="btn-del"  onclick="excluirPaciente(${idx})">Excluir</button>
      </div>
    </div>`;
  }).join('');
}

function editarPaciente(idx) {
  const p = pacientes[idx];
  const campoNome = document.getElementById("nome");
  campoNome.value = p.nome;
  document.getElementById("telefone").value = p.telefone;
  document.getElementById("categoria").value = p.categoria;
  atualizaSubcategorias();
  document.getElementById("subcategoria").value = p.subcategoria===TEXTO_LONGO ? TEXTO_CURTO : p.subcategoria;
  pacientes.splice(idx,1);
  salvarPacientes(); atualizarLista();
  setTimeout(()=>campoNome.focus(),150);
}

function excluirPaciente(idx) {
  if(confirm("Deseja realmente excluir este paciente?")){ pacientes.splice(idx,1); salvarPacientes(); atualizarLista(); }
}

function resetarCamposInput() {
  document.getElementById("formPaciente").reset();
  document.getElementById("subcategoria").innerHTML='<option value="">‚Äî Selecione ‚Äî</option>';
}

function limparComSeguranca() {
  if(pacientes.length===0){ resetarCamposInput(); return; }
  const mesNome = document.getElementById("mesSelecionado").selectedOptions[0].text;
  if(confirm(`Deseja exportar um backup antes de apagar os dados de ${mesNome}?`)){
    exportarBackup();
    executarLimpeza(mesNome);
  } else if(confirm(`Tem certeza que deseja apagar TUDO de ${mesNome} SEM backup?`)){
    executarLimpeza(mesNome);
  }
}

function executarLimpeza(mes) {
  pacientes=[];
  salvarPacientes(); atualizarLista(); resetarCamposInput();
  alert(`Dados de ${mes} limpos com sucesso.`);
  verificarDadosFaltantes();
}

function salvarPacientes() {
  const ma = document.getElementById("mesSelecionado").value;
  localStorage.setItem("pacientes_"+ma, JSON.stringify(pacientes));
}

function carregarPacientesMes() {
  const ma = document.getElementById("mesSelecionado").value;
  const d = localStorage.getItem("pacientes_"+ma);
  pacientes = d ? JSON.parse(d) : [];
  pacientes = pacientes.map(p=>{ if(p.subcategoria===TEXTO_LONGO) p.subcategoria=TEXTO_CURTO; return p; });
  atualizarLista();
}

function popularMeses() {
  const sel = document.getElementById("mesSelecionado");
  const now = new Date();
  const anoAtual = now.getFullYear();
  sel.innerHTML="";
  for(let i=0;i<12;i++){
    const d = new Date(anoAtual,i,1);
    const ma = d.toISOString().slice(0,7);
    let nome = d.toLocaleString('pt-BR',{month:'long',year:'numeric'});
    nome = nome.charAt(0).toUpperCase()+nome.slice(1);
    const o = document.createElement("option");
    o.value=ma; o.textContent=nome;
    if(i===now.getMonth()) o.selected=true;
    sel.appendChild(o);
  }
}

function popularAnosRelatorio() {
  const sel = document.getElementById("anoRelatorioAnual");
  const anoAtual = new Date().getFullYear();
  sel.innerHTML="";
  for(let a=anoAtual;a>=anoAtual-5;a--){
    const o = document.createElement("option");
    o.value=a; o.textContent=a;
    sel.appendChild(o);
  }
  sel.addEventListener('change',atualizarInfoMeses);
}

function verificarDadosFaltantes() {
  const anoAtual = new Date().getFullYear();
  let mesesComDados=0;
  for(let m=0;m<12;m++){
    const ma = new Date(anoAtual,m,1).toISOString().slice(0,7);
    const d = localStorage.getItem("pacientes_"+ma);
    if(d&&JSON.parse(d).length>0) mesesComDados++;
  }
  const mesAtual = new Date().getMonth()+1;
  if(mesesComDados<mesAtual-1) document.getElementById("alertBackup").classList.add("show");
}

function atualizarInfoMeses() {
  const ano = parseInt(document.getElementById("anoRelatorioAnual").value);
  const div = document.getElementById("mesesDisponiveis");
  let meses=[],total=0;
  for(let m=0;m<12;m++){
    const d=new Date(ano,m,1), ma=d.toISOString().slice(0,7);
    const raw=localStorage.getItem("pacientes_"+ma);
    if(raw){const p=JSON.parse(raw);if(p.length>0){meses.push({nome:d.toLocaleString('pt-BR',{month:'long'}),qt:p.length});total+=p.length;}}
  }
  if(meses.length===0){
    div.innerHTML=`<strong>‚ö†Ô∏è Nenhum dado encontrado para ${ano}</strong>Importe o backup primeiro!`;
  } else {
    div.innerHTML=`<strong>üìä Dados em ${ano}</strong>${total} caso(s) em ${meses.length} m√™s(es): `+meses.map(m=>`${m.nome} (${m.qt})`).join(', ');
  }
}

function abrirModalRelatorioAnual() {
  popularAnosRelatorio(); atualizarInfoMeses();
  document.getElementById("modalRelatorioAnual").classList.add("open");
}

function fecharModalRelatorioAnual() {
  document.getElementById("modalRelatorioAnual").classList.remove("open");
}

function confirmarRelatorioAnual() {
  const ano = parseInt(document.getElementById("anoRelatorioAnual").value);
  fecharModalRelatorioAnual();
  gerarPDFAnual(ano);
}

function exportarBackup() {
  const backup={};
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i);
    if(k.startsWith("pacientes_")) backup[k]=localStorage.getItem(k);
  }
  const a=Object.assign(document.createElement('a'),{
    href:URL.createObjectURL(new Blob([JSON.stringify(backup)],{type:'application/json'})),
    download:`backup_neoplasias_${new Date().toISOString().slice(0,10)}.json`
  });
  a.click();
}

function importarBackup(event) {
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const b=JSON.parse(e.target.result);
      let n=0;
      for(const k in b){localStorage.setItem(k,b[k]);n++;}
      alert(`Backup importado!\n${n} m√™s(es) restaurado(s).`);
      verificarDadosFaltantes();
      location.reload();
    }catch(err){alert("Erro ao importar backup. Verifique o arquivo.");}
  };
  reader.readAsText(event.target.files[0]);
}

/* ‚îÄ‚îÄ‚îÄ PDF ‚îÄ‚îÄ‚îÄ */
function gerarPDF() {
  if(pacientes.length===0){alert("Adicione pacientes primeiro.");return;}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  const mes=document.getElementById("mesSelecionado").selectedOptions[0].text;
  _gerarPDFComum(doc, pacientes, mes, null);
  doc.save(`Relat√≥rio de Neoplasias - ${mes}.pdf`);
}

function gerarPDFAnual(ano) {
  const todos=[];
  for(let m=0;m<12;m++){
    const d=new Date(ano,m,1),ma=d.toISOString().slice(0,7);
    const raw=localStorage.getItem("pacientes_"+ma);
    if(raw){
      const ps=JSON.parse(raw).map(p=>{
        if(p.subcategoria===TEXTO_LONGO)p.subcategoria=TEXTO_CURTO;
        return {...p, mes:d.toLocaleString('pt-BR',{month:'long'})};
      });
      todos.push(...ps);
    }
  }
  if(todos.length===0){alert(`‚ùå Sem dados em ${ano}!\n\nImporte o backup e tente novamente.`);return;}
  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  _gerarPDFComum(doc, todos, null, ano);
  doc.save(`Relat√≥rio Anual de Neoplasias - ${ano}.pdf`);
}

function _gerarPDFComum(doc, lista, mes, ano) {
  const titulo = ano ? "RELAT√ìRIO ANUAL DE NEOPLASIAS" : "RELAT√ìRIO MENSAL DE NEOPLASIAS";
  const refLabel = ano ? `Ano de Refer√™ncia: ${ano}` : `M√™s de Refer√™ncia: ${mes}`;

  const cab = (sub) => {
    doc.setFont("helvetica","bold"); doc.setFontSize(14); doc.setTextColor(azulEscuro);
    doc.text(sub, 105, 20, {align:"center"});
    doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(cinzaEscuro);
    doc.text("UNIDADE M√ìVEL SESC ‚Äì SA√öDE DA MULHER", 105, 27, {align:"center"});
    doc.setFontSize(10); doc.setTextColor("#333");
    doc.text(refLabel, 190, 35, {align:"right"});
    doc.setDrawColor(azulEscuro); doc.setLineWidth(0.5); doc.line(20,38,190,38);
    doc.setFontSize(7); doc.setTextColor(cinzaEscuro);
    doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`,190,285,{align:"right"});
  };

  // P√°gina 1 ‚Äî lista de pacientes
  cab(titulo + " ‚Äî RELA√á√ÉO DE PACIENTES");
  let y=48;
  lista.forEach(p=>{
    if(y>270){doc.addPage();cab(titulo+" ‚Äî RELA√á√ÉO DE PACIENTES");y=48;}
    doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor("#000");
    doc.text(p.nome,20,y); y+=6;
    doc.setFont("helvetica","normal"); doc.setFontSize(9); doc.setTextColor(azulEscuro);
    const mesInfo = p.mes ? ` | M√äS: ${p.mes.toUpperCase()}` : '';
    doc.text(`TEL: ${p.telefone}${mesInfo}`,20,y); y+=5;
    const diag=p.subcategoria===TEXTO_LONGO?TEXTO_CURTO:p.subcategoria;
    const lines=doc.splitTextToSize(`DIAGN√ìSTICO: ${diag}`,170);
    lines.forEach(l=>{doc.text(l,20,y);y+=4.5;});
    y+=5;
  });

  // P√°gina estat√≠stica
  doc.addPage(); cab(titulo+" ‚Äî COMPARATIVO ESTAT√çSTICO"); y=48;
  const resumo={};
  Object.keys(subcategorias).forEach(cat=>{
    const catPac=lista.filter(p=>p.categoria===cat);
    if(catPac.length===0)return;
    resumo[cat]=catPac.length;
    if(y>250){doc.addPage();cab(titulo+" ‚Äî COMPARATIVO ESTAT√çSTICO");y=48;}
    doc.setFillColor(238,244,251); doc.rect(20,y-5,170,7,'F');
    doc.setFont("helvetica","bold"); doc.setFontSize(10); doc.setTextColor(azulEscuro);
    doc.text(cat,22,y); y+=10;
    const counts={};
    catPac.forEach(p=>{const s=p.subcategoria===TEXTO_LONGO?TEXTO_CURTO:p.subcategoria;counts[s]=(counts[s]||0)+1;});
    doc.setFont("helvetica","normal"); doc.setFontSize(9);
    for(const[s,c] of Object.entries(counts)){
      const sl=doc.splitTextToSize(s,140);
      sl.forEach(l=>{doc.text(l,25,y);y+=5;});
      doc.setFont("helvetica","bold"); doc.text(`${c} caso(s)`,185,y-5,{align:"right"});
      doc.setFont("helvetica","normal"); y+=3;
    }
    y+=5;
  });

  if(y>200){doc.addPage();cab(titulo+" ‚Äî COMPARATIVO ESTAT√çSTICO");y=48;}
  y+=10;
  doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(azulEscuro);
  doc.text("DISTRIBUI√á√ÉO POR CATEGORIA",105,y,{align:"center"}); y+=10;
  const total=lista.length;
  const maxB=120;
  Object.entries(resumo).forEach(([n,t])=>{
    const perc=t/total, lb=perc*maxB;
    doc.setFontSize(8); doc.setTextColor(cinzaEscuro); doc.setFont("helvetica","bold");
    doc.text(n.length>45?n.substring(0,42)+"...":n,20,y); y+=5;
    doc.setFillColor(245,245,245); doc.rect(20,y,maxB,6,'F');
    doc.setFillColor(11,60,93); doc.rect(20,y,lb,6,'F');
    doc.setFontSize(9); doc.setTextColor("#000");
    doc.text(`${t} (${(perc*100).toFixed(1)}%)`,25+maxB,y+4.5);
    y+=12;
  });

  // distribui√ß√£o por m√™s (relat√≥rio anual)
  if(ano){
    if(y>180){doc.addPage();cab(titulo+" ‚Äî COMPARATIVO ESTAT√çSTICO");y=48;}
    y+=10;
    doc.setFont("helvetica","bold"); doc.setFontSize(12); doc.setTextColor(azulEscuro);
    doc.text("DISTRIBUI√á√ÉO POR M√äS",105,y,{align:"center"}); y+=10;
    for(let m=0;m<12;m++){
      const d=new Date(ano,m,1),ma=d.toISOString().slice(0,7);
      const raw=localStorage.getItem("pacientes_"+ma);
      const qt=raw?JSON.parse(raw).length:0;
      if(y>260){doc.addPage();cab(titulo+" ‚Äî COMPARATIVO ESTAT√çSTICO");y=48;}
      const perc=total>0?qt/total:0, lb=perc*maxB;
      const mesN=d.toLocaleString('pt-BR',{month:'long'});
      doc.setFontSize(8); doc.setTextColor(cinzaEscuro); doc.setFont("helvetica","bold");
      doc.text(mesN.charAt(0).toUpperCase()+mesN.slice(1),20,y); y+=5;
      doc.setFillColor(245,245,245); doc.rect(20,y,maxB,6,'F');
      doc.setFillColor(25,118,210); doc.rect(20,y,lb,6,'F');
      doc.setFontSize(9); doc.setTextColor("#000");
      doc.text(`${qt} caso(s) (${(perc*100).toFixed(1)}%)`,25+maxB,y+4.5);
      y+=12;
    }
  }

  // assinatura
  const fY=265;
  doc.setDrawColor(200,200,200); doc.setLineWidth(0.2); doc.line(70,fY,140,fY);
  doc.setFont("helvetica","bold"); doc.setFontSize(11); doc.setTextColor(azulEscuro);
  doc.text("MARCOS PONTES",105,fY+6,{align:"center"});
  doc.setFont("helvetica","normal"); doc.setFontSize(8); doc.setTextColor(cinzaEscuro);
  doc.text("Respons√°vel T√©cnico",105,fY+10,{align:"center"});
  const dataF=new Date().toLocaleDateString('pt-BR',{day:'numeric',month:'long',year:'numeric'});
  doc.text(`Gerado em Jo√£o Pessoa, ${dataF}`,20,285);
}

popularMeses();
carregarPacientesMes();
verificarDadosFaltantes();
</script>
</body>
</html>
